---
title: ubuntu20 安装周立功Can卡驱动
categories:
  - SWU-Car
tags:
  - swu-car
  - ubuntu
  - 周立功 PCIE 9120i
---

# ubuntu20安装周立功Can卡驱动

> 2020年1月17日的时候，由于我使用的是 R8125 的网卡，ubuntu20 的内核为*5.8.38* 不支持，所以我升级了内核为 *5.10.0*
>
> 关于如何升级内核，请看另一篇文章：[ubutu20不支持B460的R8125网卡：升级内核为5.10]()

先去下载对应设备的linux驱动。我的设备是 *PCIE 9120I*

[https://manual.zlg.cn/web/#/65?page_id=2627](https://manual.zlg.cn/web/#/65?page_id=2627)

下载后得到一个zip文件(*我新建了一个zlg-can*目录来存放)。解压，使用命令 

`unzip 5fa2730c74694.zip`

![image-20210117183737014](/public/img/image-20210117183737014.png)

### 一，把 *sja1000.h* 复制到内核Can驱动中

```
sudo cp sja1000.h /usr/src/your-kernel-source/drivers/net/can/sja1000/sja1000.h
```

其中*your-kernel-source*需要根据目前使用的系统修改。可以使用使用命令 `uname -r`来查看：

![image-20210117184103226](/public/img/image-20210117184103226.png)

`sudo cp sja1000.h /usr/src/linux-headers-5.10.0-051000/drivers/net/can/sja1000/`

![image-20210117184004608](/public/img/image-20210117184004608.png)

### 二，编辑 *Makefile*，修改*KDIR*参数，编译

`vim Makefile`

![image-20210117222714587](/public/img/image-20210117222714587.png)

然后编译

`make`

![image-20210117221838607](/public/img/image-20210117221838607.png)

这就表示编译成功了！

### 三，安装驱动

`sudo insmod zpcican.ko`

这个命令我直接输入会出错：

![image-20210117222935390](/public/img/image-20210117222935390.png)

输入`modinfo ./zpcican.ko |grep depend `*查看一下就知道依赖sja1000*

![image-20210117223121522](/public/img/image-20210117223121522.png)

所以我们需要先加载依赖项。

```shell
sudo modprobe sja1000 #加载以来项在执行
sudo insmod zpcican.ko #安装依赖
```

不报错就是成功了！

### 四，检查是否安装成功

`ls /sys/class/net/can*`

![image-20210117223541674](/public/img/image-20210117223541674.png)

能看到有 *can0* 和 *can1*。成功。

### 五，CAN收发测试

测试需要安装工具 *can-utils*

`sudo apt install can-utils`

==注：时间比较久，耐心等待==

我这里 CAN 已经连接到了地盘的 CAN 总线了，所以总线中是有数据的，不需要使用回环。

```shell
ip link show can0 # 查看一下
# 设置 CAN 波特率，YHS 的地盘 波特率是  500K
sudo ip link set can1 type can bitrate 500000 # 我这里连接地盘的接口的是 can1
sudo ip link set can1 up # 使能 CAN 接口
candump can1 # 进入等待接收模式，此时能收到大量总线数据

```

<img src="/public/img/Peek-2021-01-17-22-51.gif" style="zoom: 100%" />



> 当can总线不再被需要或重新配置can（波特率）时，请关闭can接口